<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>How to Input and Output with Mongo DB Data on Hadoop Platform  &middot; Rui&#39;s Home Page</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="Hadoop, MongoDB, Configuration, ">


<meta property="og:title" content="How to Input and Output with Mongo DB Data on Hadoop Platform  &middot; Rui&#39;s Home Page ">
<meta property="og:site_name" content="Rui&#39;s Home Page"/>
<meta property="og:url" content="http://xmruibi.github.io/code/MongoDBwithHadoop/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2015-04-16T12:56:15-07:00" />
<meta property="og:article:modified_time" content="2015-04-16T12:56:15-07:00" />

  
    
<meta property="og:article:tag" content="Hadoop">
    
<meta property="og:article:tag" content="MongoDB">
    
<meta property="og:article:tag" content="Configuration">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="How to Input and Output with Mongo DB Data on Hadoop Platform" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="http://xmruibi.github.io/code/MongoDBwithHadoop/" />
<meta name="twitter:domain" content="http://xmruibi.github.io">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "How to Input and Output with Mongo DB Data on Hadoop Platform",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2015-04-16",
    "description": "",
    "wordCount":  789 
  }
</script>



<link rel="canonical" href="http://xmruibi.github.io/code/MongoDBwithHadoop/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://xmruibi.github.io/touch-icon-144-precomposed.png">
<link href="http://xmruibi.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.14" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://xmruibi.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="http://xmruibi.github.io/css/style.css">
<link rel="stylesheet" href="http://xmruibi.github.io/css/search.css">
<link rel="stylesheet" href="http://xmruibi.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://xmruibi.github.io"> 
  Geek Think

</a> 

</div>

  
<div class="container topline">
  
  A Thinker, A Coder, A Traveler


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="http://xmruibi.github.io">Home</a>


  
<a href="http://xmruibi.github.io/topics/algorithm" title="Discuss algorithm questions"

>
Algorithm

</a>

<a href="http://xmruibi.github.io/code" title="Show my projects"

>
Project

</a>

<a href="http://xmruibi.gitbooks.io/interview-preparation-notes/content/" title="about Interview Preparation"

>
My GitBook

</a>

<a href="http://xmruibi.github.io/life" title="Show my travels"

>
Travel

</a>

<a href="http://xmruibi.github.io/post" title="Show list of archived posts"

>
Archive

</a>


</nav>

<div class="container nav primary no-print" style="position: relative;
 margin-top: 2em;margin-bottom: 2em; ">
<form role="search" id="search" action="/search">
	<input id="page" name="p" value="1" type="hidden"/>
	<input id="query" name="q" type="search" placeholder="Search">
</form>
 </div>
<div class="container nav secondary no-print" style="position: relative; margin-top:20em;">
  
<a href="http://xmruibi.github.io/about">About</a>

<a href="http://xmruibi.github.io/tags" title="Show list of tags">Tags</a>

<a href="http://xmruibi.github.io/topics" title="Show list of topics">Topics</a>


</div>
<div class="container nav secondary no-print" style="position: relative;
 margin-bottom: 0em;">
  
<a id="contact-link-email" class="contact_link" href="mailto:xmruibi@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/xmruibi">
  <span class="fa fa-github-square"></span><span>github</span></a>





<a id="contact-link-linkedin" class="contact_link" href="fr.linkedin.com/in/ruibi">
  <span class="fa fa-linkedin-square"></span><span>linkedin</span></a>













</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>How to Input and Output with Mongo DB Data on Hadoop Platform
</h1>

  <div class="metas">
<time datetime="2015-04-16">16 Apr, 2015</time>


  
    &middot; by Rui Bi
  
  &middot; Read in about 4 min
  &middot; (789 Words)
  <br>
  Tags: 

<a class="label" href="http://xmruibi.github.io/tags/hadoop">Hadoop; </a> 


<a class="label" href="http://xmruibi.github.io/tags/mongodb">MongoDB; </a> 


<a class="label" href="http://xmruibi.github.io/tags/configuration">Configuration; </a> 


  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  Topics: 

<a class="label" href="http://xmruibi.github.io/topics/devops">DevOps; </a> 


<a class="label" href="http://xmruibi.github.io/topics/cloud-computing">Cloud Computing; </a> 


</div>

</header>

  <div class="container content">
  

<p>In the previous article, I&rsquo;ve talked about how to distributed a Mongo DB database in multiple virtual machine. Here, I&rsquo;d like to discuss how we can make data stream between Mongo DB and Hadoop. In fact, the format from MongoDB cannot directly used in Hadoop Map Reduce function. You have to use Mongo Hadoop API to assist you for finishing this difficult connection between MongoDB and Hadoop.</p>

<h2 id="introduction">Introduction</h2>

<p>The MongoDB Connector for Hadoop is a plugin for Hadoop that provides the ability to use MongoDB as an input source and/or an output destination. The major advantage is that once the connector is implemented, the analytic power of Hadoop can be utilized with the MongoDB storage architecture.
&gt; “The Connector presents MongoDB as a Hadoop-compatible file system allowing a MapReduce job to read from MongoDB directly without first copying it to HDFS, thereby eliminating the need to move Terabytes of data across the network. MapReduce jobs can pass queries as filters, so avoiding the need to scan entire collections, and can also take advantage of MongoDB’s rich indexing capabilities including geospatial, text-search, array, compound and sparse indexes”</p>

<h2 id="procedure">Procedure</h2>

<p>Once we choose MongoDB as the I/O target, all of our I/O format needs to fit with MongoDB document format, thus we must use either JSON or BSON. So the entire procedure when Hadoop works with MongoDB is shown as follows:
- Create MongoDB URL builder with multiple Mongos (Routers) as Database entrances
- Set one MongoDB collection as input source with MongoDB URL builder
- Use Hadoop as Map-Reduce computing framework.
- Override Mapper class with BSON format as value in.
- Override Reduce class addressing the BSON data and output the data with MongodbUpdateWritable format
- Set another MongoDB collection as output destination  with MongoDB URL builder</p>

<h2 id="talk-is-cheap-show-me-the-code">Talk is cheap, show me the code!</h2>

<h3 id="access-to-mongo-db">Access to Mongo DB</h3>

<p>By create MongoDB URL builder, the hadoop platform can detect the database position. However, we have multiple Mongo DB routers as Database entrances. So we just save our entry IP address as a list.</p>

<pre><code class="language-java">private MongoClientURIBuilder ShardedDBURIBuilder() {
		// mainly host
		String mainHost = &quot;44XX.XXX.XXX.X01&quot;;

		// set up the option entrances when the main one shut down
		List&lt;ServerAddress&gt; serverSeeds;
		MongoClient mongoClient = null;
		serverSeeds = new ArrayList&lt;ServerAddress&gt;();
		try {
			serverSeeds.add(new ServerAddress(&quot;4XX.XXX.XXX.X02&quot;, 27017));
			serverSeeds.add(new ServerAddress(&quot;4XX.XXX.XXX.X03&quot;, 27017));
			mongoClient = new MongoClient(serverSeeds);
			mongoClient.getMongoClientOptions();
		} catch (UnknownHostException e) {
			log.error(e + &quot;&quot; + e.getCause());
		}

		MongoClientURIBuilder uriBuilder = new MongoClientURIBuilder();
		uriBuilder.addHost(mainHost, 27017);
		uriBuilder.options(mongoClient.getMongoClientOptions());
		return uriBuilder;
}
</code></pre>

<p>Then we know where is the Mongo DB! But we still need to locate the collection in MongoDB and more detailed information. Here we go:</p>

<pre><code class="language-java">MongoClientURIBuilder uriBuilder = ShardedDBURIBuilder();
uriBuilder.collection(&quot;stock&quot;, &quot;symbols&quot;);
MongoClientURI inputURI = uriBuilder.build();
MongoConfigUtil.setInputURI(getConf(), inputURI);
</code></pre>

<h3 id="build-our-own-mapper-and-reducer">Build our own mapper and reducer!</h3>

<p>Here I use my project about stock information crawler as an example. Mapper read the stock symbol data from the MongoDB. Then it get a list of symbol name in mapper. The mapper has separated that list and the reducer should read different part of list and search the stock information according to the partial symbol name list.</p>

<ul>
<li>Override Mapper class with BSON format as value in.</li>
</ul>

<pre><code class="language-java">public class SymbolsMapper extends Mapper&lt;Object, BSONObject, Text, IntWritable&gt;{
    @Override
    public void map(Object key, BSONObject val, final Context context) 
        throws IOException, InterruptedException {
    	System.out.println(val.get(&quot;symbol&quot;)+&quot;  Mapper Getted!!&quot;);
        context.write(new Text((val.get(&quot;symbol&quot;)).toString()), 
        		new IntWritable(1));
    }
}
</code></pre>

<ul>
<li>Override Reduce class addressing the BSON data and output the data with MongodbUpdateWritable format</li>
</ul>

<pre><code class="language-java">public class SymbolsReducer extends Reducer&lt;Text, IntWritable, NullWritable, MongoUpdateWritable&gt;{
	
    @Override
    public void reduce(final Text pKey, final Iterable&lt;IntWritable&gt; pValues,
                        final Context pContext )
            throws IOException, InterruptedException{
    	    
        StockCrawler stockCrawler = new StockCrawler();
        
        // get symbol from keyIn 
        Quote quote = stockCrawler.getHistQuotesBySymbol(pKey.toString());
        if(quote==null||quote.getSymbolName()==null||quote.getHistorical_quotes()==null)
        	return;
        // get Quote info, set new id
        BasicBSONObject query = new BasicBSONObject(&quot;_id&quot;, quote.getKey());
       
        // set symbol name and symbol quotes
        BasicBSONObject stockQuote = new BasicBSONObject();
        stockQuote.put(&quot;symbol&quot;, quote.getSymbolName());
        ArrayList&lt;Object&gt; historical_quotes =  quote.getHistorical_quotes();
        
        BasicBSONObject update = new BasicBSONObject(&quot;$set&quot;, stockQuote);
        update.append(&quot;$pushAll&quot;, new BasicBSONObject(&quot;historical_quotes&quot;, historical_quotes));
        
        pContext.write(null, new MongoUpdateWritable(query, update, true, false));
    }
}
</code></pre>

<h3 id="output-back-to-mongo-db">Output back to Mongo DB</h3>

<p>The output procedure is very simliar with the input one. But just the difference on the target collection in Mongo DB.</p>

<pre><code class="language-java">MongoClientURI outputURI = uriBuilder.build();
MongoConfigUtil.setOutputURI(getConf(), outputURI);
</code></pre>

<h3 id="the-overview-on-this-connector">The overview on this connector:</h3>

<pre><code class="language-java">public MongoMapredStockCrawler() {
		setConf(new Configuration());

		if (MongoTool.isMapRedV1()) {
			MapredMongoConfigUtil.setInputFormat(getConf(),
					com.mongodb.hadoop.mapred.MongoInputFormat.class);
			MapredMongoConfigUtil.setOutputFormat(getConf(),
					com.mongodb.hadoop.mapred.MongoOutputFormat.class);
		} else {
			MongoConfigUtil.setInputFormat(getConf(), MongoInputFormat.class);
			MongoConfigUtil.setOutputFormat(getConf(), MongoOutputFormat.class);
		}

		MongoClientURIBuilder uriBuilder = ShardedDBURIBuilder();
		uriBuilder.collection(&quot;stock&quot;, &quot;symbols&quot;);
		MongoClientURI inputURI = uriBuilder.build();
		uriBuilder.collection(&quot;stock&quot;, &quot;quotes&quot;);
		MongoClientURI outputURI = uriBuilder.build();

		MongoConfigUtil.setInputURI(getConf(), inputURI);
		MongoConfigUtil.setOutputURI(getConf(), outputURI);

		MongoConfigUtil.setMapper(getConf(), SymbolsMapper.class);
		MongoConfigUtil.setReducer(getConf(), SymbolsReducer.class);

		MongoConfigUtil.setMapperOutputKey(getConf(), Text.class);
		MongoConfigUtil.setMapperOutputValue(getConf(), IntWritable.class);

		MongoConfigUtil.setOutputKey(getConf(), IntWritable.class);
		MongoConfigUtil.setOutputValue(getConf(), BSONWritable.class);
	}
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>This is very typical example when people need to read data from Mongo DB and process the data on Hadoop platform and then back the data to Mongo DB. Since there is very little instruction about this work, I just shared my idea on that.</p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="http://xmruibi.github.io/code/DistributedMongoDB/" title="Distributed MongoDB Configuration">
      Earlier Article
    </a>
    

    
    <a class="next" href="http://xmruibi.github.io/code/SpringBoot/" title="Architecture Design on Social Music Search project">
      Newer Article
    </a>
    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//ruisblog.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
<a class="toplink" href="#">Go top</a>

</div>
<div class="container nav foot no-print">
  

  
</div>
  <div class="container credits">
  
<div class="container footline">
  
  Code with <i class='fa fa-heart'> Rui Bi</i>


</div>


  
<div class="container copyright">
  
  &copy; 2015 Rui Bi.


</div>


</div>

</footer>

    </main>
    <script src="http://xmruibi.github.io/js/jquery.min.js"></script>
<script src="http://xmruibi.github.io/js/bootstrap.min.js"></script>
<script src="http://xmruibi.github.io/js/bootstrap.js"></script>
<script src="http://xmruibi.github.io/js/npm.js"></script>
<script src="http://xmruibi.github.io/js/prism.js"></script>
<script src="http://xmruibi.github.io/js/handlebars.js"></script>
<script src="http://xmruibi.github.io/js/search.js"></script>




<script src="http://xmruibi.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
    Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-69058903-1', 'auto');
  ga('send', 'pageview');;
</script>



    
  </body>
</html>

